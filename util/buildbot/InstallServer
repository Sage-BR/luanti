#!/bin/bash
set -e

# 1. Dependências
sudo apt update
sudo apt install -y g++ ninja-build cmake libsqlite3-dev libcurl4-openssl-dev \
    zlib1g-dev libgmp-dev libjsoncpp-dev libzstd-dev libncurses-dev \
    libgettextpo-dev libleveldb-dev libpq-dev libhiredis-dev libspatialindex-dev \
    libssl-dev gettext

# 2. LuaJIT
git clone https://github.com/LuaJIT/LuaJIT luajit
cd luajit
make amalg
cd ..

# 3. Luanti
git clone -b stable-5 --depth 1 https://github.com/luanti-org/luanti.git
cd luanti
mkdir build && cd build

cmake .. -G Ninja \
  -DBUILD_CLIENT=0 \
  -DBUILD_SERVER=1 \
  -DRUN_IN_PLACE=1 \
  -DBUILD_UNITTESTS=0 \
  -DLUA_INCLUDE_DIR=../../luajit/src \
  -DLUA_LIBRARY=../../luajit/src/libluajit.a \
  -DENABLE_CURL=ON \
  -DENABLE_CURSES=ON \
  -DENABLE_GETTEXT=ON \
  -DENABLE_LEVELDB=ON \
  -DENABLE_POSTGRESQL=ON \
  -DENABLE_REDIS=ON \
  -DENABLE_SPATIAL=ON \
  -DENABLE_OPENSSL=ON \
  -DENABLE_LTO=ON \
  -DENABLE_SYSTEM_GMP=ON \
  -DENABLE_SYSTEM_JSONCPP=ON \
  -DENABLE_UPDATE_CHECKER=TRUE

ninja
cd ../..

# 4. Copiar arquivos para /root/SERVER
mkdir -p /root/SERVER
cp -r luanti/bin luanti/builtin luanti/client luanti/games luanti/mods luanti/textures /root/SERVER
mkdir -p /root/SERVER/worlds
touch /root/SERVER/server.conf

# Criar mundo padrão se não existir
if [ ! -d /root/SERVER/worlds/world ]; then
    /root/SERVER/bin/luantiserver --world /root/SERVER/worlds/world --config /root/SERVER/server.conf --gameid minetest --mapgen v7 --quit
fi

# 5. Criar service
cat <<EOF | sudo tee /etc/systemd/system/luanti.service
[Unit]
Description=Luanti Game Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/SERVER
ExecStart=/root/SERVER/bin/luantiserver --world /root/SERVER/worlds/world --config /root/SERVER/server.conf
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# 6. Ativar service
sudo systemctl daemon-reload
sudo systemctl enable luanti.service
sudo systemctl start luanti.service

echo "✅ Servidor Luanti instalado e iniciado."
